{%load static%}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Image Links - TV Shop Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', sans-serif;
        }

       
        .main-content {
            margin-left: 250px;
            padding: 30px;
        }

        /* Section Card Styling */
        .section-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
            border: 1px solid #dee2e6;
            overflow: hidden; /* For header radius */
        }

        .section-header {
            background-color: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Tile Grid */
        .tile-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
            padding: 20px;
        }

        .image-tile {
            position: relative;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
            background: white;
            transition: transform 0.2s;
        }

        .image-tile:hover {
            transform: translateY(-3px);
            border-color: #3498db;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .tile-img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            background-color: #eee;
        }

        .tile-actions {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255,255,255,0.9);
            border-radius: 4px;
            padding: 2px;
            display: none;
        }

        .image-tile:hover .tile-actions {
            display: block;
        }

        .tile-label {
            padding: 8px 5px;
            font-size: 0.8rem;
            text-align: center;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            background: white;
            border-top: 1px solid #f0f0f0;
        }

        @media (max-width: 768px) {
            .sidebar { width: 0; }
            .main-content { margin-left: 0; }
        }
    </style>
        <link rel="stylesheet" href="{% static 'Admin/css/admin_style.css' %}" />
</head>
<body>
    {% include "admin_sidebar.html"%} {% include "admin_header.html"%}


    <div class="main-content">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="fw-bold">Homepage Image Links</h2>
                <p class="text-muted">Manage clickable image grids (Categories, Brands, Offers).</p>
            </div>
            <button class="btn btn-primary btn-lg" onclick="openSectionModal()">
                <i class="fas fa-folder-plus me-2"></i> Create New Section
            </button>
        </div>

        <div id="dynamic-sections-area">
            </div>

    </div>

    <div class="modal fade" id="sectionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="secModalTitle">Create New Section</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="sectionForm">
                        <input type="hidden" id="editSecId">
                        <div class="mb-3">
                            <label class="form-label">Section Title</label>
                            <input type="text" class="form-control" id="secTitleInput" placeholder="e.g. Shop by Size" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Internal Description</label>
                            <input type="text" class="form-control" id="secDescInput" placeholder="e.g. Links to filter by inch size">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveSection()">Save Section</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="tileModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Image Tile</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="tileForm">
                        <input type="hidden" id="editTileId">
                        <input type="hidden" id="targetSectionId">

                        <div class="mb-3 text-center">
                            <div class="bg-light p-3 border rounded mb-2">
                                <img id="imgPreview" src="https://via.placeholder.com/150" style="max-height: 100px;">
                            </div>
                            <input type="file" class="form-control" id="imgInput" accept="image/*">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Label Name</label>
                            <input type="text" class="form-control" id="tileLabel" placeholder="e.g. 55 Inch">
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold text-primary">Target Link (Filter Page)</label>
                            <input type="text" class="form-control" id="tileLink" placeholder="/search?size=55" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveTile()">Save Image</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // 1. Data Structure (Array of Sections)
        let sections = [
            {
                id: 1,
                title: "Shop by Category",
                desc: "Main product categories",
                tiles: [
                    { id: 101, label: "OLED TVs", link: "/category/oled", img: "https://via.placeholder.com/150/000000/FFFFFF?text=OLED" },
                    { id: 102, label: "QLED TVs", link: "/category/qled", img: "https://via.placeholder.com/150/333333/FFFFFF?text=QLED" }
                ]
            },
            {
                id: 2,
                title: "Popular Brands",
                desc: "Top manufacturer logos",
                tiles: [
                    { id: 201, label: "Samsung", link: "/brand/samsung", img: "https://via.placeholder.com/150/003366/FFFFFF?text=Samsung" }
                ]
            }
        ];

        // 2. Render All Sections
        function renderSections() {
            const container = document.getElementById('dynamic-sections-area');
            container.innerHTML = "";

            sections.forEach(sec => {
                // Generate Tiles HTML
                let tilesHtml = "";
                if(sec.tiles.length === 0) {
                    tilesHtml = `<div class="col-12 text-muted small text-center py-3 border rounded bg-light border-dashed">No images yet. Click "Add Image" to start.</div>`;
                } else {
                    sec.tiles.forEach(tile => {
                        tilesHtml += `
                            <div class="image-tile">
                                <div class="tile-actions">
                                    <button class="btn btn-sm btn-light border px-2" onclick="openTileModal(${sec.id}, ${tile.id})"><i class="fas fa-pen text-primary"></i></button>
                                    <button class="btn btn-sm btn-light border px-2 text-danger" onclick="deleteTile(${sec.id}, ${tile.id})"><i class="fas fa-trash"></i></button>
                                </div>
                                <img src="${tile.img}" class="tile-img">
                                <div class="tile-label" title="${tile.label}">${tile.label}</div>
                            </div>
                        `;
                    });
                }

                // Render Section Card
                const sectionHtml = `
                    <div class="section-card">
                        <div class="section-header">
                            <div>
                                <h5 class="fw-bold mb-0 text-dark">
                                    <i class="fas fa-layer-group me-2 text-muted"></i>${sec.title}
                                </h5>
                                <small class="text-muted">${sec.desc}</small>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="openTileModal(${sec.id})">
                                    <i class="fas fa-plus"></i> Add Image
                                </button>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                        <i class="fas fa-cog"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><a class="dropdown-item" href="#" onclick="openSectionModal(${sec.id})">Edit Section Title</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteSection(${sec.id})">Delete Section</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="tile-grid">
                            ${tilesHtml}
                        </div>
                    </div>
                `;
                container.innerHTML += sectionHtml;
            });
        }

        // 3. SECTION Logic (Add / Edit / Delete)
        const secModal = new bootstrap.Modal(document.getElementById('sectionModal'));

        function openSectionModal(id = null) {
            document.getElementById('sectionForm').reset();
            document.getElementById('editSecId').value = "";
            
            if(id) {
                // Edit Mode
                const s = sections.find(x => x.id === id);
                document.getElementById('editSecId').value = s.id;
                document.getElementById('secTitleInput').value = s.title;
                document.getElementById('secDescInput').value = s.desc;
                document.getElementById('secModalTitle').innerText = "Edit Section";
            } else {
                // Add Mode
                document.getElementById('secModalTitle').innerText = "Create New Section";
            }
            secModal.show();
        }

        function saveSection() {
            const id = document.getElementById('editSecId').value;
            const title = document.getElementById('secTitleInput').value;
            const desc = document.getElementById('secDescInput').value;

            if(!title) return alert("Title is required");

            if(id) {
                // Update
                const index = sections.findIndex(x => x.id == id);
                sections[index].title = title;
                sections[index].desc = desc;
            } else {
                // Create
                sections.push({
                    id: Date.now(),
                    title: title,
                    desc: desc,
                    tiles: []
                });
            }
            secModal.hide();
            renderSections();
        }

        function deleteSection(id) {
            if(confirm("Delete this entire section? All images inside it will be removed.")) {
                sections = sections.filter(x => x.id !== id);
                renderSections();
            }
        }

        // 4. TILE Logic (Add / Edit / Delete)
        const tileModal = new bootstrap.Modal(document.getElementById('tileModal'));

        function openTileModal(secId, tileId = null) {
            document.getElementById('tileForm').reset();
            document.getElementById('targetSectionId').value = secId;
            document.getElementById('editTileId').value = "";
            document.getElementById('imgPreview').src = "https://via.placeholder.com/150";

            if(tileId) {
                // Edit Tile
                const sec = sections.find(s => s.id === secId);
                const tile = sec.tiles.find(t => t.id === tileId);
                document.getElementById('editTileId').value = tile.id;
                document.getElementById('tileLabel').value = tile.label;
                document.getElementById('tileLink').value = tile.link;
                document.getElementById('imgPreview').src = tile.img;
            }
            tileModal.show();
        }

        function saveTile() {
            const secId = parseInt(document.getElementById('targetSectionId').value);
            const tileId = document.getElementById('editTileId').value;
            const label = document.getElementById('tileLabel').value;
            const link = document.getElementById('tileLink').value;
            const img = document.getElementById('imgPreview').src;

            const secIndex = sections.findIndex(s => s.id === secId);

            if(tileId) {
                // Update existing tile
                const tileIndex = sections[secIndex].tiles.findIndex(t => t.id == tileId);
                sections[secIndex].tiles[tileIndex] = { id: parseInt(tileId), label, link, img };
            } else {
                // Add new tile
                sections[secIndex].tiles.push({
                    id: Date.now(),
                    label, link, img
                });
            }
            tileModal.hide();
            renderSections();
        }

        function deleteTile(secId, tileId) {
            if(confirm("Remove this image?")) {
                const secIndex = sections.findIndex(s => s.id === secId);
                sections[secIndex].tiles = sections[secIndex].tiles.filter(t => t.id !== tileId);
                renderSections();
            }
        }

        // Image Preview Listener
        document.getElementById('imgInput').addEventListener('change', function(e) {
            if (e.target.files && e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('imgPreview').src = e.target.result;
                }
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        // Init
        renderSections();

    </script>
</body>
</html>