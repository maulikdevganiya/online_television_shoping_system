{%load static%}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Orders - TV Shop Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="{% static 'css/a_order.css' %}" />

</head>
<body>
    {% include "dash.html"%}
    <div class="main-content">
        
        <h2 class="fw-bold mb-4">Order Management</h2>

        <div class="row mb-4">
            <div class="col-md-3">
                <div class="order-card bg-primary">
                    <h5>Total Orders</h5>
                    <h2 id="totalOrders">0</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="order-card bg-warning text-dark">
                    <h5>Pending</h5>
                    <h2 id="pendingOrders">0</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="order-card bg-success">
                    <h5>Completed</h5>
                    <h2 id="completedOrders">0</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="order-card bg-danger">
                    <h5>Cancelled</h5>
                    <h2 id="cancelledOrders">0</h2>
                </div>
            </div>
        </div>

        <div class="table-card">
            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                <div class="d-flex gap-2">
                    <select class="form-select" id="statusFilter" onchange="filterOrders()">
                        <option value="All">All Statuses</option>
                        <option value="Pending">Pending</option>
                        <option value="Processing">Processing</option>
                        <option value="Shipped">Shipped</option>
                        <option value="Cancelled">Cancelled</option>
                    </select>
                    <button class="btn btn-outline-secondary"><i class="fas fa-filter"></i> Filter Date</button>
                </div>
                <div class="input-group" style="max-width: 300px;">
                    <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                    <input type="text" class="form-control border-start-0 ps-0" id="searchInput" placeholder="Search Order ID or Name..." onkeyup="searchOrders()">
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Date</th>
                            <th>Total</th>
                            <th>Payment</th>
                            <th>Status</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody">
                        </tbody>
                </table>
            </div>
            
            <div class="d-flex justify-content-between align-items-center mt-3">
                <small class="text-muted">Showing 1 to 5 of 12 entries</small>
                <nav>
                    <ul class="pagination pagination-sm mb-0">
                        <li class="page-item disabled"><a class="page-link" href="#">Prev</a></li>
                        <li class="page-item active"><a class="page-link" href="#">1</a></li>
                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                        <li class="page-item"><a class="page-link" href="#">Next</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <div class="modal fade" id="orderDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Order Details <span id="modalOrderId" class="text-muted ms-2">#ORD-001</span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="fw-bold text-primary">Customer Information</h6>
                            <p class="mb-0" id="modalCustomerName">John Doe</p>
                            <p class="mb-0 text-muted" id="modalCustomerEmail">john@example.com</p>
                            <p class="mb-0 text-muted">+1 234 567 890</p>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <h6 class="fw-bold text-primary">Shipping Address</h6>
                            <p class="mb-0 text-muted">123 TV Street, Tech City</p>
                            <p class="mb-0 text-muted">New York, NY 10001</p>
                            <p class="mb-0 text-muted">United States</p>
                        </div>
                    </div>

                    <h6 class="fw-bold">Items Ordered</h6>
                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Product Name</th>
                                <th class="text-center">Qty</th>
                                <th class="text-end">Unit Price</th>
                                <th class="text-end">Total</th>
                            </tr>
                        </thead>
                        <tbody id="modalItemsBody">
                            </tbody>
                        <tfoot class="table-light">
                            <tr>
                                <td colspan="3" class="text-end fw-bold">Subtotal</td>
                                <td class="text-end" id="modalSubtotal">$0.00</td>
                            </tr>
                            <tr>
                                <td colspan="3" class="text-end text-muted">Tax (5%)</td>
                                <td class="text-end" id="modalTax">$0.00</td>
                            </tr>
                            <tr>
                                <td colspan="3" class="text-end fw-bold fs-5">Grand Total</td>
                                <td class="text-end fw-bold fs-5 text-primary" id="modalTotal">$0.00</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-outline-secondary"><i class="fas fa-print"></i> Print Invoice</button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // 1. Mock Data (Simulating Database)
        let orders = [
            { id: "ORD-7890", customer: "Michael Scott", email: "m.scott@dunder.com", date: "2025-11-26", total: 1250, payment: "Credit Card", status: "Pending", items: [{name: "Sony Bravia 55\"", qty: 1, price: 1250}] },
            { id: "ORD-7891", customer: "Pam Beesly", email: "pam@art.com", date: "2025-11-25", total: 2400, payment: "PayPal", status: "Processing", items: [{name: "LG OLED 65\"", qty: 1, price: 2400}] },
            { id: "ORD-7892", customer: "Jim Halpert", email: "jim@sports.com", date: "2025-11-24", total: 800, payment: "Credit Card", status: "Shipped", items: [{name: "TCL Roku 40\"", qty: 2, price: 400}] },
            { id: "ORD-7893", customer: "Dwight Schrute", email: "dwight@farms.com", date: "2025-11-22", total: 3500, payment: "Bank Transfer", status: "Cancelled", items: [{name: "Samsung Neo QLED 8K", qty: 1, price: 3500}] },
            { id: "ORD-7894", customer: "Stanley Hudson", email: "stanley@pretzel.com", date: "2025-11-21", total: 500, payment: "Credit Card", status: "Shipped", items: [{name: "Soundbar JBL", qty: 1, price: 500}] }
        ];

        // 2. Render Orders Table
        const tableBody = document.getElementById('ordersTableBody');

        function renderOrders(data) {
            tableBody.innerHTML = "";
            let stats = { total: 0, pending: 0, shipped: 0, cancelled: 0 };

            data.forEach(order => {
                // Update Stats logic
                stats.total++;
                if(order.status === 'Pending') stats.pending++;
                if(order.status === 'Shipped') stats.shipped++;
                if(order.status === 'Cancelled') stats.cancelled++;

                // Determine Badge Color
                let badgeClass = '';
                switch(order.status) {
                    case 'Pending': badgeClass = 'status-pending'; break;
                    case 'Processing': badgeClass = 'status-processing'; break;
                    case 'Shipped': badgeClass = 'status-shipped'; break;
                    case 'Cancelled': badgeClass = 'status-cancelled'; break;
                }

                // Render Row
                let row = `
                    <tr>
                        <td class="fw-bold text-primary">${order.id}</td>
                        <td>
                            <div class="fw-bold">${order.customer}</div>
                            <small class="text-muted">${order.email}</small>
                        </td>
                        <td>${order.date}</td>
                        <td>$${order.total.toLocaleString()}</td>
                        <td><i class="far fa-credit-card me-1"></i> ${order.payment}</td>
                        <td><span class="status-badge ${badgeClass}">${order.status}</span></td>
                        <td class="text-end">
                            <div class="dropdown">
                                <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="viewDetails('${order.id}')"><i class="fas fa-eye me-2"></i>View Details</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="updateStatus('${order.id}', 'Shipped')"><i class="fas fa-truck me-2"></i>Mark as Shipped</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="updateStatus('${order.id}', 'Cancelled')"><i class="fas fa-times me-2"></i>Cancel Order</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="#"><i class="fas fa-trash me-2"></i>Delete</a></li>
                                </ul>
                            </div>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });

            // Update Top Cards
            document.getElementById('totalOrders').innerText = stats.total;
            document.getElementById('pendingOrders').innerText = stats.pending;
            document.getElementById('completedOrders').innerText = stats.shipped;
            document.getElementById('cancelledOrders').innerText = stats.cancelled;
        }

        // 3. Initial Load
        renderOrders(orders);

        // 4. View Details Function
        const detailModal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));

        function viewDetails(id) {
            const order = orders.find(o => o.id === id);
            
            // Fill Modal Info
            document.getElementById('modalOrderId').innerText = "#" + order.id;
            document.getElementById('modalCustomerName').innerText = order.customer;
            document.getElementById('modalCustomerEmail').innerText = order.email;
            
            // Fill Items Table
            const itemsBody = document.getElementById('modalItemsBody');
            itemsBody.innerHTML = "";
            let subtotal = 0;

            order.items.forEach(item => {
                let itemTotal = item.qty * item.price;
                subtotal += itemTotal;
                itemsBody.innerHTML += `
                    <tr>
                        <td>${item.name}</td>
                        <td class="text-center">${item.qty}</td>
                        <td class="text-end">$${item.price.toLocaleString()}</td>
                        <td class="text-end">$${itemTotal.toLocaleString()}</td>
                    </tr>
                `;
            });

            // Calculate Totals
            let tax = subtotal * 0.05;
            let grandTotal = subtotal + tax;

            document.getElementById('modalSubtotal').innerText = "$" + subtotal.toLocaleString();
            document.getElementById('modalTax').innerText = "$" + tax.toFixed(2);
            document.getElementById('modalTotal').innerText = "$" + grandTotal.toLocaleString();

            detailModal.show();
        }

        // 5. Update Status Function
        function updateStatus(id, newStatus) {
            const order = orders.find(o => o.id === id);
            if(order) {
                order.status = newStatus;
                renderOrders(orders); // Refresh table
                alert(`Order ${id} updated to ${newStatus}`);
            }
        }

        // 6. Search Function
        function searchOrders() {
            const val = document.getElementById('searchInput').value.toLowerCase();
            const filtered = orders.filter(o => 
                o.id.toLowerCase().includes(val) || 
                o.customer.toLowerCase().includes(val)
            );
            renderOrders(filtered);
        }

        // 7. Filter Function
        function filterOrders() {
            const status = document.getElementById('statusFilter').value;
            if(status === 'All') {
                renderOrders(orders);
            } else {
                renderOrders(orders.filter(o => o.status === status));
            }
        }
    </script>
</body>
</html>