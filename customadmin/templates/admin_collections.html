{%load static%}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homepage Sections - TV Shop Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', sans-serif;
        }


        .main-content {
            margin-left: 250px;
            padding: 30px;
        }

        /* Collection Card Styling */
        .collection-card {
            border: none;
            border-radius: 12px;
            background: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            transition: transform 0.2s;
            height: 100%;
        }

        .collection-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .preview-grid {
            display: flex;
            gap: 5px;
            margin: 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            overflow-x: auto;
        }

        .preview-img {
            width: 50px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }

        .product-selector-item {
            cursor: pointer;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: 0.2s;
        }

        .product-selector-item:hover {
            background-color: #f8f9fa;
        }

        .product-selector-item.selected {
            background-color: #e3f2fd;
            border-color: #3498db;
        }

        .status-dot {
            height: 10px;
            width: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        @media (max-width: 768px) {
            .sidebar { width: 0; }
            .main-content { margin-left: 0; }
        }
    </style>
    <link rel="stylesheet" href="{% static 'Admin/css/admin_style.css' %}" />
</head>
<body>

    {% include "admin_sidebar.html"%} {% include "admin_header.html"%}

    <div class="main-content">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="fw-bold">Homepage Collections</h2>
                <p class="text-muted">Create specific product showcases for your index page.</p>
            </div>
            <button class="btn btn-primary" onclick="openModal()">
                <i class="fas fa-plus-circle me-2"></i> Create New Section
            </button>
        </div>

        <div class="row g-4" id="collectionsGrid">
            </div>

    </div>

    <div class="modal fade" id="collectionModal" tabindex="-1">
        <div class="modal-dialog modal-lg"> <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Configure Section</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="collectionForm">
                        <input type="hidden" id="editId">

                        <div class="row mb-3">
                            <div class="col-md-8">
                                <label class="form-label">Section Title</label>
                                <input type="text" class="form-control" id="secTitle" placeholder="e.g. Big Screen, Bigger Savings" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="secStatus">
                                    <option value="Active">Active</option>
                                    <option value="Draft">Draft (Hidden)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label class="form-label">Subtitle / Promo Text</label>
                            <input type="text" class="form-control" id="secSubtitle" placeholder="e.g. Get up to 50% off on 55+ inch TVs">
                        </div>

                        <div class="card bg-light border-0">
                            <div class="card-header bg-transparent d-flex justify-content-between">
                                <span class="fw-bold">Select Products</span>
                                <span class="badge bg-primary" id="selectCount">0 / 5 Selected</span>
                            </div>
                            <div class="card-body p-2" style="max-height: 300px; overflow-y: auto;" id="productList">
                                </div>
                        </div>
                        <div class="form-text text-danger mt-1 d-none" id="limitAlert">
                            You can only select up to 5 products per section.
                        </div>

                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveCollection()">Save Section</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // 1. Available Products (Inventory)
        const inventory = [
            { id: 101, name: "Samsung Crystal UHD 55\"", price: 599, img: "https://via.placeholder.com/50/000000/FFFFFF?text=Sam55" },
            { id: 102, name: "LG OLED C3 65\"", price: 1599, img: "https://via.placeholder.com/50/333333/FFFFFF?text=LG65" },
            { id: 103, name: "Sony Bravia XR 50\"", price: 899, img: "https://via.placeholder.com/50/555555/FFFFFF?text=Sony50" },
            { id: 104, name: "TCL Roku Smart 43\"", price: 299, img: "https://via.placeholder.com/50/777777/FFFFFF?text=TCL43" },
            { id: 105, name: "Samsung Neo QLED 75\"", price: 2499, img: "https://via.placeholder.com/50/000000/FFFFFF?text=Sam75" },
            { id: 106, name: "Hisense U8H 55\"", price: 649, img: "https://via.placeholder.com/50/222222/FFFFFF?text=His55" },
            { id: 107, name: "Vizio V-Series 50\"", price: 349, img: "https://via.placeholder.com/50/444444/FFFFFF?text=Viz50" },
        ];

        // 2. Existing Collections (Mock Data)
        let collections = [
            {
                id: 1,
                title: "Big Screen, Bigger Savings",
                subtitle: "Exclusive deals on 55+ inch displays",
                status: "Active",
                productIds: [101, 102, 105, 106] // 4 items selected
            },
            {
                id: 2,
                title: "Budget Friendly Picks",
                subtitle: "Top rated TVs under $500",
                status: "Active",
                productIds: [104, 107] // 2 items selected
            }
        ];

        // 3. Render Collections Grid
        function renderCollections() {
            const grid = document.getElementById('collectionsGrid');
            grid.innerHTML = "";

            collections.forEach(col => {
                // Get product details for previews
                let imagesHtml = "";
                col.productIds.forEach(pid => {
                    const prod = inventory.find(p => p.id === pid);
                    if(prod) imagesHtml += `<img src="${prod.img}" class="preview-img" title="${prod.name}">`;
                });

                let statusColor = col.status === 'Active' ? 'bg-success' : 'bg-secondary';

                grid.innerHTML += `
                    <div class="col-md-6 col-xl-4">
                        <div class="collection-card p-4">
                            <div class="d-flex justify-content-between mb-2">
                                <h5 class="fw-bold mb-0 text-truncate">${col.title}</h5>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-light" data-bs-toggle="dropdown"><i class="fas fa-ellipsis-v"></i></button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" onclick="editCollection(${col.id})">Edit</a></li>
                                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteCollection(${col.id})">Delete</a></li>
                                    </ul>
                                </div>
                            </div>
                            <p class="text-muted small mb-3">${col.subtitle}</p>
                            
                            <h6 class="text-primary small fw-bold">Displayed Products (${col.productIds.length}/5)</h6>
                            <div class="preview-grid">
                                ${imagesHtml || '<small class="text-muted p-2">No products selected</small>'}
                            </div>

                            <div class="mt-3">
                                <span class="status-dot ${statusColor}"></span> <span class="small text-muted">${col.status}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        // 4. Modal Logic
        const modal = new bootstrap.Modal(document.getElementById('collectionModal'));
        let selectedIds = []; // Temp storage for checkboxes

        function openModal() {
            document.getElementById('collectionForm').reset();
            document.getElementById('editId').value = "";
            document.getElementById('modalTitle').innerText = "Create New Section";
            selectedIds = [];
            renderProductList();
            modal.show();
        }

        function editCollection(id) {
            const col = collections.find(c => c.id === id);
            document.getElementById('editId').value = col.id;
            document.getElementById('secTitle').value = col.title;
            document.getElementById('secSubtitle').value = col.subtitle;
            document.getElementById('secStatus').value = col.status;
            
            selectedIds = [...col.productIds]; // Clone array
            renderProductList();
            document.getElementById('modalTitle').innerText = "Edit Section";
            modal.show();
        }

        // 5. Render Product Checklist in Modal
        function renderProductList() {
            const list = document.getElementById('productList');
            list.innerHTML = "";

            inventory.forEach(p => {
                const isSelected = selectedIds.includes(p.id);
                const activeClass = isSelected ? 'selected' : '';
                const checkIcon = isSelected ? '<i class="fas fa-check-circle text-primary"></i>' : '<i class="far fa-circle text-muted"></i>';

                list.innerHTML += `
                    <div class="product-selector-item ${activeClass}" onclick="toggleProduct(${p.id})">
                        <div class="d-flex align-items-center">
                            <img src="${p.img}" style="width:30px; margin-right:10px;">
                            <div>
                                <div class="fw-bold small">${p.name}</div>
                                <div class="text-muted small" style="font-size:0.75rem;">$${p.price}</div>
                            </div>
                        </div>
                        ${checkIcon}
                    </div>
                `;
            });
            updateCount();
        }

        // 6. Toggle Logic (Max 5)
        function toggleProduct(pid) {
            const index = selectedIds.indexOf(pid);
            const alertBox = document.getElementById('limitAlert');

            if (index > -1) {
                // Remove if already selected
                selectedIds.splice(index, 1);
                alertBox.classList.add('d-none');
            } else {
                // Add if limit not reached
                if (selectedIds.length < 5) {
                    selectedIds.push(pid);
                    alertBox.classList.add('d-none');
                } else {
                    alertBox.classList.remove('d-none');
                }
            }
            renderProductList();
        }

        function updateCount() {
            document.getElementById('selectCount').innerText = `${selectedIds.length} / 5 Selected`;
        }

        // 7. Save Function
        function saveCollection() {
            const id = document.getElementById('editId').value;
            const title = document.getElementById('secTitle').value;
            const subtitle = document.getElementById('secSubtitle').value;
            const status = document.getElementById('secStatus').value;

            if(!title) { alert("Please enter a title"); return; }

            if(id) {
                // Update
                const index = collections.findIndex(c => c.id == id);
                collections[index] = { id: parseInt(id), title, subtitle, status, productIds: selectedIds };
            } else {
                // Create
                collections.push({
                    id: Date.now(),
                    title, subtitle, status,
                    productIds: selectedIds
                });
            }

            modal.hide();
            renderCollections();
        }

        function deleteCollection(id) {
            if(confirm("Delete this homepage section?")) {
                collections = collections.filter(c => c.id !== id);
                renderCollections();
            }
        }

        // Initial Load
        renderCollections();

    </script>
</body>
</html>