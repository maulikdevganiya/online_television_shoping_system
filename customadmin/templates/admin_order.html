{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manage Orders - TV Shop Admin</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <link rel="stylesheet" href="{% static 'Admin/css/a_order.css' %}" />
    <link rel="stylesheet" href="{% static 'Admin/css/admin_style.css' %}" />
    
    <style>
        /* Add status badge colors explicitly for JS rendered rows */
        .status-badge { padding: 5px 10px; border-radius: 20px; font-size: 0.85em; font-weight: 600; }
        .status-pending { background-color: #fff3cd; color: #856404; }
        .status-processing { background-color: #cff4fc; color: #055160; }
        .status-shipped { background-color: #d1e7dd; color: #0f5132; }
        .status-cancelled { background-color: #f8d7da; color: #842029; }
    </style>
  </head>
  <body>
    {% include "admin_sidebar.html"%} {% include "admin_header.html"%}

    <div class="main-content">
      <h2 class="fw-bold mb-4">Order Management</h2>

      <div class="row mb-4">
        <div class="col-md-3">
          <div class="order-card bg-primary text-white p-3 rounded">
            <h5>Total Orders</h5>
            <h2 id="totalOrders">{{ total_orders }}</h2>
          </div>
        </div>
        <div class="col-md-3">
          <div class="order-card bg-warning text-dark p-3 rounded">
            <h5>Pending</h5>
            <h2 id="pendingOrders">{{ pending_orders }}</h2>
          </div>
        </div>
        <div class="col-md-3">
          <div class="order-card bg-success text-white p-3 rounded">
            <h5>Completed</h5>
            <h2 id="completedOrders">{{ completed_orders }}</h2>
          </div>
        </div>
        <div class="col-md-3">
          <div class="order-card bg-danger text-white p-3 rounded">
            <h5>Cancelled</h5>
            <h2 id="cancelledOrders">{{ cancelled_orders }}</h2>
          </div>
        </div>
      </div>

      <div class="table-card bg-white p-4 rounded shadow-sm">
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
          <div class="d-flex gap-2">
            <select class="form-select" id="statusFilter" onchange="filterOrders()">
              <option value="All">All Statuses</option>
              <option value="pending">Pending</option>
              <option value="processing">Processing</option>
              <option value="shipped">Shipped</option>
              <option value="cancelled">Cancelled</option>
            </select>
            <button class="btn btn-outline-secondary" onclick="location.reload()">
              <i class="fas fa-sync"></i> Refresh
            </button>
          </div>
          <div class="input-group" style="max-width: 300px">
            <span class="input-group-text bg-white border-end-0">
                <i class="fas fa-search text-muted"></i>
            </span>
            <input
              type="text"
              class="form-control border-start-0 ps-0"
              id="searchInput"
              placeholder="Search Order ID or Name..."
              onkeyup="searchOrders()"
            />
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>Order ID</th>
                <th>Customer</th>
                <th>Date</th>
                <th>Total</th>
                <th>Payment</th>
                <th>Status</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody id="ordersTableBody">
              {% for order in orders %}
              <tr>
                <td class="fw-bold text-primary">#{{ order.order_number }}</td>
                <td>
                  <div class="fw-bold">{{ order.user.first_name }} {{ order.user.last_name }}</div>
                  <small class="text-muted">{{ order.email }}</small>
                </td>
                <td>{{ order.created_at|date:"M d, Y" }}</td>
                <td>{{ order.total_amount|floatformat:2 }}</td>
                
                <td>
                  <i class="far fa-credit-card me-1 text-muted"></i> 
                  {# Try get_display first, then raw field, then fallback #}
                  {% if order.payment.first %}
                    {{ order.payment.first.get_payment_method_display|default:order.payment.first.payment_method }}
                  {% else %}
                    <span class="text-muted">Not Paid</span>
                  {% endif %}
                </td>

                <td>
                  <span
                    class="status-badge {% if order.status == 'pending' %}status-pending{% elif order.status == 'processing' %}status-processing{% elif order.status == 'shipped' %}status-shipped{% elif order.status == 'cancelled' %}status-cancelled{% endif %}"
                  >
                    {{ order.get_status_display|default:order.status|title }}
                  </span>
                </td>
                <td class="text-end">
                  <div class="dropdown">
                    <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown">
                      <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <ul class="dropdown-menu">
                      <li>
                        <a class="dropdown-item" href="#" onclick="viewDetails('{{ order.id }}')">
                            <i class="fas fa-eye me-2"></i>View Details
                        </a>
                      </li>
                      <li><hr class="dropdown-divider" /></li>
                      <li><a class="dropdown-item" href="#" onclick="updateStatus('{{ order.id }}', 'pending')"><i class="fas fa-clock me-2 text-warning"></i>Mark Pending</a></li>
                      <li><a class="dropdown-item" href="#" onclick="updateStatus('{{ order.id }}', 'processing')"><i class="fas fa-cog me-2 text-info"></i>Mark Processing</a></li>
                      <li><a class="dropdown-item" href="#" onclick="updateStatus('{{ order.id }}', 'shipped')"><i class="fas fa-truck me-2 text-success"></i>Mark Shipped</a></li>
                      <li><a class="dropdown-item" href="#" onclick="updateStatus('{{ order.id }}', 'cancelled')"><i class="fas fa-times me-2 text-danger"></i>Cancel Order</a></li>
                    </ul>
                  </div>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="7" class="text-center text-muted py-4">
                  <i class="fas fa-shopping-cart fa-2x mb-2"></i>
                  <br />No orders found.
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="modal fade" id="orderDetailsModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title fw-bold">
              Order Details <span id="modalOrderId" class="text-muted ms-2"></span>
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="row mb-4">
              <div class="col-md-6">
                <h6 class="fw-bold text-primary">Customer Information</h6>
                <p class="mb-0" id="modalCustomerName"></p>
                <p class="mb-0 text-muted" id="modalCustomerEmail"></p>
                <p class="mb-0 text-muted" id="modalCustomerPhone"></p>
              </div>
              <div class="col-md-6 text-md-end">
                <h6 class="fw-bold text-primary">Shipping Address</h6>
                <p class="mb-0 text-muted" id="modalAddress"></p>
              </div>
            </div>

            <h6 class="fw-bold">Items Ordered</h6>
            <table class="table table-bordered">
              <thead class="table-light">
                <tr>
                  <th>Product Name</th>
                  <th class="text-center">Qty</th>
                  <th class="text-end">Unit Price</th>
                  <th class="text-end">Total</th>
                </tr>
              </thead>
              <tbody id="modalItemsBody"></tbody>
              <tfoot class="table-light">
                <tr>
                  <td colspan="3" class="text-end fw-bold fs-5">Grand Total</td>
                  <td class="text-end fw-bold fs-5 text-primary" id="modalTotal"></td>
                </tr>
              </tfoot>
            </table>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // 1. Get orders data from Django context
      let orders = [
        {% for order in orders %}
        {
          id: "{{ order.id }}",
          order_number: "{{ order.order_number }}",
          customer: "{{ order.user.first_name }} {{ order.user.last_name }}",
          email: "{{ order.email }}", // Use order email usually captured at checkout
          phone: "{{ order.phone }}",
          address: "{{ order.shipping_address|escapejs }}",
          date: "{{ order.created_at|date:'M d, Y' }}",
          total: {{ order.total_amount|floatformat:2 }},
          // FIXED JS DATA INJECTION FOR PAYMENT
          payment: "{% if order.payment.first %}{{ order.payment.first.get_payment_method_display|default:order.payment.first.payment_method }}{% else %}Not Paid{% endif %}",
          status: "{{ order.status }}",
          items: [
            {% for item in order.order_items.all %}
            {
              name: "{{ item.product.title|escapejs }}",
              qty: {{ item.quantity }},
              price: {{ item.price|floatformat:2 }}
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
          ]
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
      ];

      // 2. Render Orders Table
      const tableBody = document.getElementById("ordersTableBody");

      function renderOrders(data) {
        tableBody.innerHTML = "";

        if (data.length === 0) {
          tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-muted py-4">No orders found.</td></tr>`;
          return;
        }

        data.forEach((order) => {
          let badgeClass = "";
          switch (order.status) {
            case "pending": badgeClass = "status-pending"; break;
            case "processing": badgeClass = "status-processing"; break;
            case "shipped": badgeClass = "status-shipped"; break;
            case "cancelled": badgeClass = "status-cancelled"; break;
          }

          let row = `
            <tr>
                <td class="fw-bold text-primary">#${order.order_number}</td>
                <td>
                    <div class="fw-bold">${order.customer}</div>
                    <small class="text-muted">${order.email}</small>
                </td>
                <td>${order.date}</td>
                <td>$${order.total.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
                <td><i class="far fa-credit-card me-1 text-muted"></i> ${order.payment}</td>
                <td><span class="status-badge ${badgeClass}">${order.status.charAt(0).toUpperCase() + order.status.slice(1)}</span></td>
                <td class="text-end">
                    <div class="dropdown">
                        <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="viewDetails('${order.id}')"><i class="fas fa-eye me-2"></i>View Details</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="updateStatus('${order.id}', 'pending')"><i class="fas fa-clock me-2 text-warning"></i>Mark Pending</a></li>
                            <li><a class="dropdown-item" href="#" onclick="updateStatus('${order.id}', 'processing')"><i class="fas fa-cog me-2 text-info"></i>Mark Processing</a></li>
                            <li><a class="dropdown-item" href="#" onclick="updateStatus('${order.id}', 'shipped')"><i class="fas fa-truck me-2 text-success"></i>Mark Shipped</a></li>
                            <li><a class="dropdown-item" href="#" onclick="updateStatus('${order.id}', 'cancelled')"><i class="fas fa-times me-2 text-danger"></i>Cancel Order</a></li>
                        </ul>
                    </div>
                </td>
            </tr>
          `;
          tableBody.innerHTML += row;
        });
      }

      // 3. View Details Function
      const detailModal = new bootstrap.Modal(document.getElementById("orderDetailsModal"));

      function viewDetails(id) {
        const order = orders.find((o) => o.id === id);
        if(!order) return;

        document.getElementById("modalOrderId").innerText = "#" + order.order_number;
        document.getElementById("modalCustomerName").innerText = order.customer;
        document.getElementById("modalCustomerEmail").innerText = order.email;
        document.getElementById("modalCustomerPhone").innerText = order.phone;
        document.getElementById("modalAddress").innerText = order.address;

        const itemsBody = document.getElementById("modalItemsBody");
        itemsBody.innerHTML = "";
        
        order.items.forEach((item) => {
          let itemTotal = item.qty * item.price;
          itemsBody.innerHTML += `
            <tr>
                <td>${item.name}</td>
                <td class="text-center">${item.qty}</td>
                <td class="text-end">$${item.price.toFixed(2)}</td>
                <td class="text-end">$${itemTotal.toFixed(2)}</td>
            </tr>
          `;
        });

        document.getElementById("modalTotal").innerText = "$" + order.total.toFixed(2);
        detailModal.show();
      }

      // 4. Update Status Function
      // Inside your <script> tag in admin_orders.html

// Inside your <script> tag

function updateStatus(id, newStatus) {
    if (confirm(`Are you sure you want to update this order to ${newStatus}?`)) {
        
        // 1. Generate the base URL using Django template tag (using '0' as placeholder)
        const baseUrl = "{% url 'update_order_status' 0 %}";
        
        // 2. Replace the '0' with the actual Order ID
        const finalUrl = baseUrl.replace('0', id);

        fetch(finalUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ status: newStatus })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload(); 
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => console.error('Error:', error));
    }
}
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }

      function searchOrders() {
        const val = document.getElementById("searchInput").value.toLowerCase();
        const filtered = orders.filter(o => 
            o.order_number.toLowerCase().includes(val) || 
            o.customer.toLowerCase().includes(val)
        );
        renderOrders(filtered);
      }

      function filterOrders() {
        const status = document.getElementById("statusFilter").value;
        if (status === "All") {
          renderOrders(orders);
        } else {
          renderOrders(orders.filter((o) => o.status === status));
        }
      }
    </script>
  </body>
</html>